<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-7-8 呼吸法引導工具 (手機穩定修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 核心圓球設置 (使用 vw 單位實現手機響應式) */
        .breathing-ball {
            /* 設置過渡，用於吸氣和吐氣 */
            transition-property: all;
            transition-timing-function: ease-in-out;
            
            width: 50vw;  
            height: 50vw; 
            max-width: 300px; 
            max-height: 300px; 
            
            transform: scale(1.0); 
            
            background-color: #4a90e2; 
            box-shadow: 
                0 0 10px rgba(74, 144, 226, 0.8), 
                0 0 20px rgba(74, 144, 226, 0.6), 
                0 0 40px rgba(74, 144, 226, 0.4), 
                0 0 60px rgba(74, 144, 226, 0.2); 
            
            z-index: 10;
        }
        
        .high-z-index {
            z-index: 20;
            position: relative; 
        }

        /* 【關鍵修正】簡化波動動畫，避免複雜 Keyframes 衝突 */
        @keyframes simple-pulse {
            0%, 100% { transform: scale(1.0); } 
            50% { transform: scale(1.01); } /* 極輕微波動 */
        }

        /* 應用於憋氣階段的波動 */
        .pulse-animation-simple {
            /* 這次我們將動畫持續時間設得長一些，並使用 forwards 確保穩定 */
            animation: simple-pulse 4s infinite ease-in-out forwards;
        }

        @media (max-width: 640px) {
            #countdown-text {
                font-size: 4rem; 
            }
        }
    </style>
    <script>
        const ball = document.getElementById('breathing-ball');
        const text = document.getElementById('instruction-text');
        const countdownText = document.getElementById('countdown-text');
        const button = document.getElementById('toggle-button');
        let isRunning = false;
        let intervalId;

        const TIMES = {
            IN: 4,      
            HOLD: 7,    
            OUT: 8      
        };
        
        // 規格點
        const SCALE_MIN = 0.5; 
        const SCALE_MAX = 1.5; 

        function setTransitionDuration(seconds) {
            ball.style.transitionDuration = `${seconds}s`;
        }

        function startCountdown(duration, nextPhaseCallback) {
            let timeLeft = duration;
            
            countdownText.classList.remove('opacity-0');
            countdownText.textContent = timeLeft;

            clearInterval(intervalId);

            intervalId = setInterval(() => {
                timeLeft--;
                countdownText.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(intervalId);
                    countdownText.classList.add('opacity-0');
                    nextPhaseCallback();
                }
            }, 1000);
        }
        
        // --- 核心呼吸循環邏輯 ---

        // 1. 吸氣 (Inhale): 區間 1 (MIN) -> 區間 2 (MIN->MAX)
        function inhale() {
            if (!isRunning) return;
            
            text.textContent = "開始吸氣...";
            
            // 【修正：確保移除波動類別】
            ball.classList.remove('pulse-animation-simple'); 
            ball.style.transform = `scale(${SCALE_MIN})`; 

            // 使用 requestAnimationFrame 確保瀏覽器完成前一個幀的渲染，再開始新過渡
            requestAnimationFrame(() => {
                text.textContent = "吸氣區間..."; 
                setTransitionDuration(TIMES.IN);
                
                // 【關鍵點】吸氣：從 MIN 轉換到 MAX
                ball.style.transform = `scale(${SCALE_MAX})`; 
                startCountdown(TIMES.IN, hold);
            });
        }

        // 2. 憋氣 (Hold): 區間 3 (MAX)
        function hold() {
            if (!isRunning) return;

            text.textContent = "憋氣..."; 
            
            // 【關鍵修正】確保圓球在 MAX 尺寸上，且過渡時間設為極短，避免尺寸跳變
            setTransitionDuration(0.01); 
            ball.style.transform = `scale(${SCALE_MAX})`; 
            
            // 【關鍵點】添加新的簡化波動類別
            ball.classList.add('pulse-animation-simple'); 
            
            startCountdown(TIMES.HOLD, exhale);
        }

        // 3. 吐氣 (Exhale): 區間 4 (MAX->MIN) -> 區間 5 (MIN)
        function exhale() {
            if (!isRunning) return;

            // 區間 4: 顯示「吐氣區間...」
            text.textContent = "吐氣區間..."; 
            setTransitionDuration(TIMES.OUT);
            
            // 移除波動
            ball.classList.remove('pulse-animation-simple');
            
            // 【關鍵點】吐氣：從 MAX 轉換到 MIN (確保銜接下一次吸氣)
            ball.style.transform = `scale(${SCALE_MIN})`; 

            // 區間 5: 銜接點的文字提示
            let countdownEndTime = TIMES.OUT * 1000;
            setTimeout(() => {
                if (isRunning) {
                     text.textContent = "吐氣銜接吸氣..."; 
                }
            }, countdownEndTime);

            startCountdown(TIMES.OUT, inhale);
        }

        // --- 控制邏輯 ---
        function startBreathing() {
            if (isRunning) return;
            
            isRunning = true;
            button.textContent = "停止";
            
            ball.style.transform = `scale(${SCALE_MIN})`;

            requestAnimationFrame(inhale);
        }

        function stopBreathing() {
            isRunning = false;
            button.textContent = "開始呼吸";
            text.textContent = "已暫停，點擊開始...";
            
            clearInterval(intervalId);

            countdownText.classList.add('opacity-0');
            countdownText.textContent = ''; 

            ball.classList.remove('pulse-animation-simple');
            setTransitionDuration(0.5); 
            ball.style.transform = `scale(${SCALE_MIN})`; 
        }

        function toggleBreathing() {
            if (isRunning) {
                stopBreathing();
            } else {
                startBreathing();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTransitionDuration(TIMES.IN);
        });
        
    </script>
</body>
</html>
