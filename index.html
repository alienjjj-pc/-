<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-7-8 呼吸法引導工具 (最終純JS穩定版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 核心圓球設置 (Z-index, 響應式尺寸, 過渡設置) */
        .breathing-ball {
            /* 設置過渡：用於吸氣和吐氣的平滑尺寸變化 */
            transition-property: all;
            transition-timing-function: ease-in-out;
            
            width: 50vw;  
            height: 50vw; 
            max-width: 300px; 
            max-height: 300px; 
            
            transform: scale(1.0); 
            
            background-color: #4a90e2; 
            box-shadow: 
                0 0 10px rgba(74, 144, 226, 0.8), 
                0 0 20px rgba(74, 144, 226, 0.6), 
                0 0 40px rgba(74, 144, 226, 0.4), 
                0 0 60px rgba(74, 144, 226, 0.2); 
            
            z-index: 10;
        }
        
        /* 確保文字層級更高 */
        .high-z-index {
            z-index: 20;
            position: relative; 
        }

        /* 【移除 CSS Keyframes 和 .pulse-animation-simple，避免衝突】 */

        @media (max-width: 640px) {
            #countdown-text {
                font-size: 4rem; 
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea-blue': '#0a192f',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-deep-sea-blue text-white flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-4xl font-light mb-12 tracking-wider high-z-index">4-7-8 呼吸法引導</h1>

    <div id="instruction-text" class="text-5xl font-extralight mb-4 h-20 flex items-center justify-center tracking-widest high-z-index">
        點擊下方開始按鈕...
    </div>

    <div id="countdown-text" class="text-7xl font-bold text-blue-300 mb-12 h-20 flex items-center justify-center opacity-0 transition-opacity duration-500 high-z-index">
        
    </div>

    <div id="breathing-ball" 
         class="breathing-ball rounded-full flex-shrink-0">
    </div>

    <button id="toggle-button" 
            class="mt-16 px-8 py-3 bg-blue-600 hover:bg-blue-700 text-xl rounded-full shadow-lg transition duration-300 ease-in-out high-z-index"
            onclick="toggleBreathing()">
        開始呼吸
    </button>
    
    <p class="mt-8 text-sm text-gray-400 high-z-index">吸氣 4 秒 - 憋氣 7 秒 - 吐氣 8 秒 (無限循環)</p>


    <script>
        const ball = document.getElementById('breathing-ball');
        const text = document.getElementById('instruction-text');
        const countdownText = document.getElementById('countdown-text');
        const button = document.getElementById('toggle-button');
        let isRunning = false;
        let intervalId;       // 用於計數器
        let pulseIntervalId;  // 【新增】用於純 JS 波動模擬

        const TIMES = {
            IN: 4,      
            HOLD: 7,    
            OUT: 8      
        };
        
        // 規格點
        const SCALE_MIN = 0.5; // 最小尺寸
        const SCALE_MAX = 1.5; // 最大尺寸

        // 【新增】波動參數
        const PULSE_MIN_SCALE = 1.0; 
        const PULSE_MAX_SCALE = 1.03; // 相對於 SCALE_MAX 的 3% 波動
        const PULSE_SPEED = 0.001; 

        function setTransitionDuration(seconds) {
            ball.style.transitionDuration = `${seconds}s`;
        }

        function startCountdown(duration, nextPhaseCallback) {
            let timeLeft = duration;
            
            countdownText.classList.remove('opacity-0');
            countdownText.textContent = timeLeft;

            clearInterval(intervalId);

            intervalId = setInterval(() => {
                timeLeft--;
                countdownText.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(intervalId);
                    countdownText.classList.add('opacity-0');
                    nextPhaseCallback();
                }
            }, 1000);
        }
        
        // 【新增】波動模擬函式 (純 JS 控制)
        function startPulse() {
            let isGrowing = true;
            let currentPulseScale = PULSE_MIN_SCALE;
            
            // 由於只改變 transform，所以 transitionDuration 應設為 0，避免干擾波動
            setTransitionDuration(0); 

            pulseIntervalId = setInterval(() => {
                if (!isRunning) {
                    clearInterval(pulseIntervalId);
                    return;
                }

                if (isGrowing) {
                    currentPulseScale += PULSE_SPEED;
                    if (currentPulseScale >= PULSE_MAX_SCALE) {
                        isGrowing = false;
                    }
                } else {
                    currentPulseScale -= PULSE_SPEED;
                    if (currentPulseScale <= PULSE_MIN_SCALE) {
                        isGrowing = true;
                    }
                }
                
                // 波動在 SCALE_MAX 的基礎上進行乘積縮放
                ball.style.transform = `scale(${SCALE_MAX * currentPulseScale})`;

            }, 20); // 每 20ms 更新一次波動
        }
        
        function stopPulse() {
            clearInterval(pulseIntervalId);
        }


        // --- 核心呼吸循環邏輯 ---

        // 1. 吸氣 (Inhale): 區間 1 (MIN) -> 區間 2 (MIN->MAX)
        function inhale() {
            if (!isRunning) return;
            stopPulse(); // 確保停止任何殘留的波動

            text.textContent = "開始吸氣...";
            
            ball.style.transform = `scale(${SCALE_MIN})`; 

            requestAnimationFrame(() => {
                text.textContent = "吸氣區間..."; 
                setTransitionDuration(TIMES.IN); // 4秒過渡
                
                // 圓球從 MIN 轉換到 MAX (完美銜接憋氣)
                ball.style.transform = `scale(${SCALE_MAX})`; 
                startCountdown(TIMES.IN, hold);
            });
        }

        // 2. 憋氣 (Hold): 區間 3 (MAX)
        function hold() {
            if (!isRunning) return;

            text.textContent = "憋氣..."; 
            
            // 確保圓球在 MAX 尺寸上 (這次不需要 setTransitionDuration(0.01) 因為波動函數會接管)
            ball.style.transform = `scale(${SCALE_MAX})`; 
            
            // 【關鍵點】啟動純 JS 波動，確保穩定
            startPulse();
            
            startCountdown(TIMES.HOLD, exhale);
        }

        // 3. 吐氣 (Exhale): 區間 4 (MAX->MIN) -> 區間 5 (MIN)
        function exhale() {
            if (!isRunning) return;
            stopPulse(); // 停止波動

            text.textContent = "吐氣區間..."; 
            setTransitionDuration(TIMES.OUT); // 8秒過渡
            
            // 圓球從 MAX 轉換到 MIN (完美銜接下一次吸氣)
            ball.style.transform = `scale(${SCALE_MIN})`; 

            // 區間 5: 銜接點的文字提示
            let countdownEndTime = TIMES.OUT * 1000;
            setTimeout(() => {
                if (isRunning) {
                     text.textContent = "吐氣銜接吸氣..."; 
                }
            }, countdownEndTime);

            startCountdown(TIMES.OUT, inhale);
        }

        // --- 控制邏輯 ---
        function startBreathing() {
            if (isRunning) return;
            
            isRunning = true;
            button.textContent = "停止";
            
            // 首次啟動：設置初始尺寸為最小 
            ball.style.transform = `scale(${SCALE_MIN})`;

            requestAnimationFrame(inhale);
        }

        function stopBreathing() {
            isRunning = false;
            button.textContent = "開始呼吸";
            text.textContent = "已暫停，點擊開始...";
            
            clearInterval(intervalId);
            stopPulse(); // 停止所有波動

            countdownText.classList.add('opacity-0');
            countdownText.textContent = ''; 

            // 重置圓球狀態
            setTransitionDuration(0.5); 
            ball.style.transform = `scale(${SCALE_MIN})`; 
        }

        function toggleBreathing() {
            if (isRunning) {
                stopBreathing();
            } else {
                startBreathing();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTransitionDuration(TIMES.IN);
        });
        
    </script>
</body>
</html>
