<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-7-8 呼吸法引導工具 (最終穩定版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 核心圓球設置 (使用 vw 單位實現手機響應式) */
        .breathing-ball {
            /* 過渡設置：確保 transform 平滑變化 */
            transition-property: all;
            transition-timing-function: ease-in-out;
            
            /* 尺寸設定：手機優先，並限制最大尺寸 */
            width: 50vw;  
            height: 50vw; 
            max-width: 300px; 
            max-height: 300px; 
            
            transform: scale(1.0); /* 初始尺寸 */
            
            background-color: #4a90e2; 
            box-shadow: 
                0 0 10px rgba(74, 144, 226, 0.8), 
                0 0 20px rgba(74, 144, 226, 0.6), 
                0 0 40px rgba(74, 144, 226, 0.4), 
                0 0 60px rgba(74, 144, 226, 0.2); 
            
            /* Z-index 修正：確保圓球在文字下方 */
            z-index: 10;
        }
        
        /* 確保文字層級更高 */
        .high-z-index {
            z-index: 20;
            position: relative; 
        }

        /* 憋氣波動動畫 (使用 CSS Keyframes，但只針對微小的 scale 變化) */
        /* 這是為了避免 JS 波動可能導致的性能問題，若仍不順暢，請使用 JS 波動 */
        @keyframes subtle-pulse {
            0%, 100% { transform: scale(1.0); }
            50% { transform: scale(1.03); } 
        }

        /* 應用於憋氣階段的額外波動 */
        .pulse-animation {
            /* 這裡關鍵！只影響 scale 波動，不影響 transform 基底尺寸 */
            animation: subtle-pulse 2s infinite ease-in-out;
        }

        /* 手機字體調整 */
        @media (max-width: 640px) {
            #countdown-text {
                font-size: 4rem; 
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'deep-sea-blue': '#0a192f',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-deep-sea-blue text-white flex flex-col items-center justify-center min-h-screen p-4">

    <h1 class="text-4xl font-light mb-12 tracking-wider high-z-index">4-7-8 呼吸法引導</h1>

    <div id="instruction-text" class="text-5xl font-extralight mb-4 h-20 flex items-center justify-center tracking-widest high-z-index">
        點擊下方開始按鈕...
    </div>

    <div id="countdown-text" class="text-7xl font-bold text-blue-300 mb-12 h-20 flex items-center justify-center opacity-0 transition-opacity duration-500 high-z-index">
        
    </div>

    <div id="breathing-ball" 
         class="breathing-ball rounded-full flex-shrink-0">
    </div>

    <button id="toggle-button" 
            class="mt-16 px-8 py-3 bg-blue-600 hover:bg-blue-700 text-xl rounded-full shadow-lg transition duration-300 ease-in-out high-z-index"
            onclick="toggleBreathing()">
        開始呼吸
    </button>
    
    <p class="mt-8 text-sm text-gray-400 high-z-index">吸氣 4 秒 - 憋氣 7 秒 - 吐氣 8 秒 (無限循環)</p>


    <script>
        const ball = document.getElementById('breathing-ball');
        const text = document.getElementById('instruction-text');
        const countdownText = document.getElementById('countdown-text');
        const button = document.getElementById('toggle-button');
        let isRunning = false;
        let intervalId;

        const TIMES = {
            IN: 4,      
            HOLD: 7,    
            OUT: 8      
        };
        
        // 規格點
        const SCALE_MIN = 0.5; // 最小尺寸 (開始吸氣/吐氣結束)
        const SCALE_MAX = 1.5; // 最大尺寸 (吸氣結束/憋氣/吐氣開始)

        function setTransitionDuration(seconds) {
            ball.style.transitionDuration = `${seconds}s`;
        }

        function startCountdown(duration, nextPhaseCallback) {
            let timeLeft = duration;
            
            countdownText.classList.remove('opacity-0');
            countdownText.textContent = timeLeft;

            clearInterval(intervalId);

            intervalId = setInterval(() => {
                timeLeft--;
                countdownText.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(intervalId);
                    countdownText.classList.add('opacity-0');
                    nextPhaseCallback();
                }
            }, 1000);
        }
        
        // --- 核心呼吸循環邏輯 ---

        // 1. 吸氣 (Inhale): 區間 1 (MIN) -> 區間 2 (MIN->MAX)
        function inhale() {
            if (!isRunning) return;

            // 區間 1: 顯示「開始吸氣...」 (圓球為 MIN 規格)
            text.textContent = "開始吸氣...";
            
            ball.style.transform = `scale(${SCALE_MIN})`; 
            ball.classList.remove('pulse-animation'); // 確保沒有波動

            requestAnimationFrame(() => {
                text.textContent = "吸氣區間..."; // 區間 2: 顯示「吸氣區間...」
                setTransitionDuration(TIMES.IN);
                // 圓球從 MIN 轉換到 MAX (吸氣結束規格，完美銜接憋氣)
                ball.style.transform = `scale(${SCALE_MAX})`; 
                startCountdown(TIMES.IN, hold);
            });
        }

        // 2. 憋氣 (Hold): 區間 3 (MAX)
        function hold() {
            if (!isRunning) return;

            text.textContent = "憋氣..."; // 區間 3: 顯示「憋氣...」
            
            // 確保圓球在 MAX 尺寸上
            setTransitionDuration(0.05); // 設為極短，避免過渡干擾
            ball.style.transform = `scale(${SCALE_MAX})`; 
            
            // 增加波動
            ball.classList.add('pulse-animation'); 
            
            startCountdown(TIMES.HOLD, exhale);
        }

        // 3. 吐氣 (Exhale): 區間 4 (MAX->MIN) -> 區間 5 (MIN)
        function exhale() {
            if (!isRunning) return;

            text.textContent = "吐氣區間..."; // 區間 4: 顯示「吐氣區間...」
            setTransitionDuration(TIMES.OUT);
            
            // 移除波動
            ball.classList.remove('pulse-animation');
            
            // 圓球從 MAX 轉換到 MIN (吐氣結束規格，完美銜接下一次吸氣)
            ball.style.transform = `scale(${SCALE_MIN})`; 

            // 區間 5: 銜接點的文字提示
            let countdownEndTime = TIMES.OUT * 1000;
            setTimeout(() => {
                if (isRunning) {
                     text.textContent = "吐氣銜接吸氣..."; 
                }
            }, countdownEndTime);

            startCountdown(TIMES.OUT, inhale);
        }

        // --- 控制邏輯 ---
        function startBreathing() {
            if (isRunning) return;
            
            isRunning = true;
            button.textContent = "停止";
            
            // 首次啟動：設置初始尺寸為最小 
            ball.style.transform = `scale(${SCALE_MIN})`;

            requestAnimationFrame(inhale);
        }

        function stopBreathing() {
            isRunning = false;
            button.textContent = "開始呼吸";
            text.textContent = "已暫停，點擊開始...";
            
            clearInterval(intervalId);

            countdownText.classList.add('opacity-0');
            countdownText.textContent = ''; 

            ball.classList.remove('pulse-animation');
            setTransitionDuration(0.5); 
            ball.style.transform = `scale(${SCALE_MIN})`; 
        }

        function toggleBreathing() {
            if (isRunning) {
                stopBreathing();
            } else {
                startBreathing();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTransitionDuration(TIMES.IN);
        });
        
    </script>
</body>
</html>
